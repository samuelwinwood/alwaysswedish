<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Taste My Swede: Paddy's Edition</title>
    <style>
        :root {
            --bg: #1a2e1a; /* Dark Pub Green */
            --card: #ffffff;
            --paddys: #386641; /* Paddy's Green */
            --yellow: #fecb00; /* Swedish/Sunny Yellow */
            --text: #1e293b;
            --light: #64748b;
            --red: #bc4749;
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Marker Felt', 'Comic Sans MS', sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(circle, #2a4d2a 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
        }

        #app {
            width: 100%;
            max-width: 450px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .stats-bar { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .pill {
            background: #fff;
            padding: 8px 14px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 0.8rem;
            color: var(--paddys);
            border: 3px solid var(--paddys);
            box-shadow: 4px 4px 0 var(--yellow);
        }

        .progress-outer {
            height: 16px;
            background: #000;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px solid var(--yellow);
            overflow: hidden;
        }
        #progress-fill {
            height: 100%;
            background: var(--yellow);
            width: 0%;
            transition: width 0.8s var(--bounce);
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 40px 20px;
            box-shadow: 0 20px 0 rgba(0,0,0,0.3);
            text-align: center;
            border: 5px solid #333;
            position: relative;
            transition: transform 0.3s var(--bounce);
        }

        .topic-label {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--paddys);
            color: white;
            padding: 5px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 900;
            border: 3px solid #000;
        }

        .en-text { font-size: 1.2rem; color: var(--light); margin-bottom: 20px; font-style: italic; }
        .sv-sentence { font-size: 1.8rem; font-weight: 900; line-height: 1.4; margin-bottom: 35px; }

        .blank {
            display: inline-block;
            min-width: 130px;
            padding: 0 10px;
            border-bottom: 5px dashed #ccc;
            height: 1.5em;
            vertical-align: bottom;
            transition: 0.2s;
            cursor: pointer;
            color: var(--paddys);
        }
        .blank.filled { border-bottom: 5px solid var(--yellow); background: #fffde7; }

        .bank { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 160px; }
        .tile {
            background: #fff;
            padding: 12px 18px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 1.1rem;
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            cursor: pointer;
            transition: 0.1s;
        }
        .tile:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
        .tile.hidden { display: none; }

        .btn-main {
            background: var(--yellow);
            color: #000;
            border: 4px solid #000;
            border-radius: 10px;
            padding: 20px;
            font-size: 1.5rem;
            font-weight: 900;
            box-shadow: 6px 6px 0 #000;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn-main:active { transform: translate(3px, 3px); box-shadow: 3px 3px 0 #000; }
        .btn-main.success { background: #5cb85c; color: white; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-sec { background: #eee; border: 3px solid #000; padding: 12px; font-weight: 900; border-radius: 10px; }

        #feedback { font-weight: 900; margin-bottom: 10px; height: 30px; font-size: 1.3rem; }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-3deg); } 75% { transform: rotate(3deg); } }
    </style>
</head>
<body>

<div id="app">
    <div class="stats-bar">
        <div class="pill" id="s-streak">Streak: 0 ü•õ</div>
        <div class="pill" id="s-stars">Stars: 0 ‚≠ê</div>
    </div>
    <div class="progress-outer"><div id="p-fill"></div></div>

    <div class="card" id="card">
        <div class="topic-label" id="l-topic">PADDY'S PUB</div>
        <div class="en-text" id="t-en">...</div>
        <div class="sv-sentence" id="t-sv"></div>
        <div id="feedback"></div>
        <div class="bank" id="t-bank"></div>
    </div>

    <button id="b-main" class="btn-main">Check Answer</button>
    <div class="btn-row">
        <button id="b-speak" class="btn-sec">üîä Listen</button>
        <button id="b-hint" class="btn-sec">üí° Hint</button>
    </div>
    <button id="b-reveal" style="display:none; color:red; margin-top:15px; background:none; border:none; font-weight:900;">Show Answer</button>
</div>

<script>
const SUNNY_DATA = `id,level,swedish_sentence,english_sentence,missing_word,word_bank,hint,topic
1,easy,"Dee √§r en stor __.","Dee is a big bird.",f√•gel,f√•gel|katt|hund|fisk,She has elbows that are too sharp.,The Gang
2,easy,"Jag vill ha en __.","I want a milksteak.",mj√∂lkbiff,mj√∂lkbiff|ost|pizza|hamburgare,Boiled over hard with jelly beans.,Food
3,easy,"Jag √§r __.","I am the trash man.",sopgubben,sopgubben|kungen|guden|mannen,I come out and throw trash all over the ring!,Frank
4,easy,"Vi beh√∂ver en __.","We need a boat.",b√•t,b√•t|bil|t√•g|cykel,Because of the implication.,The Ocean
5,easy,"Jag kan __.","I know bird law.",f√•gelr√§tt,f√•gelr√§tt|svenska|mat|dans,It is not governed by reason.,Charlie
6,easy,"Danny DeVito √§r __.","Danny DeVito is short.",kort,kort|l√•ng|smal|tjock,The opposite of tall.,The Gang
7,easy,"Ett __ i denna pr√∂vande tid?","An egg in this trying time?",√§gg,√§gg|√§pple|br√∂d|vin,A nice gift from Frank.,Frank
8,easy,"Vi ska √•ka __.","We are going on holiday.",p√• semester,p√• semester|till jobbet|hem|ut,Time off to get a tan.,Holiday
9,easy,"Katten har __.","The cat has mittens.",vantar,vantar|skor|hattar|glas√∂gon,Is your cat making too much noise?!,Charlie
10,easy,"Jag √§r en __.","I am a golden god.",guldgud,guldgud|stj√§rna|kung|m√§nniska,My rage knows no bounds!,Dennis
11,easy,"Drick din __.","Drink your milk.",mj√∂lk,mj√∂lk|√∂l|vin|vatten,Warm and from the McPoyles.,Food
12,easy,"H√•ll k√§ften, __!","Shut up, bird!",f√•gel,f√•gel|Dee|hund|katt,Standard greeting for Dee.,The Gang
13,easy,"Jag √§ter __.","I eat trash.",sopor,sopor|mat|godis|frukt,Frank's favorite hobby.,Frank
14,easy,"Simma med __.","Swim with the dolphins.",delfinerna,delfinerna|hajarna|fiskarna|valarna,Sea creatures that Charlie loves.,The Ocean
15,easy,"Var √§r min __?","Where is my rum ham?",romskinka,romskinka|√∂l|v√§ska|nyckel,Lost at sea!,Holiday
16,intermediate,"Det √§r __.","It is the implication.",implikationen,implikationen|planen|id√©n|felet,Why they won't say no.,The Ocean
17,intermediate,"Vildkort, __!","Wild card, bitches!",√§lsklingar,√§lsklingar|v√§nner|idioter|f√•glar,Charlie jumping out of the van.,Charlie
18,intermediate,"Nattmannen __.","The Nightman cometh.",kommer,kommer|g√•r|sover|sjunger,The hit musical.,The Gang
19,intermediate,"Jag hittade en __.","I found a crab.",krabba,krabba|fisk|skal|sten,Under the boardwalk!,The Ocean
20,intermediate,"Ge mig __.","Give me money.",pengar,pengar|√∂l|mat|hj√§lp,Money me. Money now.,Frank`;

let state = { db: [], cur: null, ans: null, streak: 0, stars: 0, tries: 0 };

function init() {
    // FIXED PARSER: Doesn't split on spaces
    const lines = SUNNY_DATA.split('\n').filter(l => l.trim());
    const headers = lines[0].split(',');
    state.db = lines.slice(1).map(l => {
        const parts = l.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        const obj = {};
        parts?.forEach((p, i) => obj[headers[i].trim()] = p.replace(/^"|"$/g, '').trim());
        return obj;
    });
    
    const saved = JSON.parse(localStorage.getItem('sunny_progress') || '{}');
    state.streak = saved.s || 0; state.stars = saved.t || 0;
    
    setup();
    next();
}

function next() {
    state.cur = state.db[Math.floor(Math.random() * state.db.length)];
    state.ans = null; state.tries = 0;
    
    document.getElementById('card').className = 'card';
    document.getElementById('t-en').innerText = state.cur.english_sentence;
    document.getElementById('l-topic').innerText = state.cur.topic;
    document.getElementById('feedback').innerText = '';
    document.getElementById('b-main').innerText = "Check Answer";
    document.getElementById('b-main').className = "btn-main";
    document.getElementById('b-reveal').style.display = 'none';

    const container = document.getElementById('t-sv');
    container.innerHTML = '';
    const parts = state.cur.swedish_sentence.split('__');
    container.append(parts[0]);
    const blank = document.createElement('span');
    blank.className = 'blank';
    blank.id = 'z-blank';
    blank.onclick = () => state.ans && remove();
    container.append(blank, parts[1] || '');

    const bank = document.getElementById('t-bank');
    bank.innerHTML = '';
    // Shuffle tiles
    state.cur.word_bank.split('|').sort(() => Math.random() - 0.5).forEach(w => {
        const t = document.createElement('div');
        t.className = 'tile';
        t.innerText = w;
        t.onclick = () => place(w);
        bank.append(t);
    });
    updateUI();
}

function place(w) {
    if (state.ans) remove();
    state.ans = w;
    document.getElementById('z-blank').innerText = w;
    document.getElementById('z-blank').className = 'blank filled';
    Array.from(document.querySelectorAll('.tile')).find(t => t.innerText === w).classList.add('hidden');
    speak(w);
}

function remove() {
    const w = state.ans;
    state.ans = null;
    document.getElementById('z-blank').innerText = '';
    document.getElementById('z-blank').className = 'blank';
    Array.from(document.querySelectorAll('.tile')).find(t => t.innerText === w).classList.remove('hidden');
}

function check() {
    if (!state.ans) return;
    const isCorrect = state.ans.toLowerCase() === state.cur.missing_word.toLowerCase();
    const fb = document.getElementById('feedback');
    const btn = document.getElementById('b-main');

    if (isCorrect) {
        state.stars++;
        if (state.tries === 0) state.streak++;
        fb.innerText = "Rock, Flag and Eagle! ü¶Ö";
        fb.style.color = "green";
        btn.innerText = "Next Round ‚Üí";
        btn.className = "btn-main success";
        localStorage.setItem('sunny_progress', JSON.stringify({s: state.streak, t: state.stars}));
        speak(state.cur.swedish_sentence.replace('__', state.ans));
    } else {
        state.tries++; state.streak = 0;
        fb.innerText = "You jabroni!";
        fb.style.color = "red";
        document.getElementById('card').classList.add('shake');
        setTimeout(() => document.getElementById('card').classList.remove('shake'), 400);
        document.getElementById('b-reveal').style.display = 'block';
    }
    updateUI();
}

function speak(t) {
    const u = new SpeechSynthesisUtterance(t);
    u.lang = 'sv-SE'; u.rate = 0.9;
    speechSynthesis.speak(u);
}

function updateUI() {
    document.getElementById('s-streak').innerText = `Streak: ${state.streak} ü•õ`;
    document.getElementById('s-stars').innerText = `Stars: ${state.stars} ‚≠ê`;
    document.getElementById('p-fill').style.width = Math.min((state.stars / 20) * 100, 100) + '%';
}

function setup() {
    document.getElementById('b-main').onclick = () => {
        if (document.getElementById('b-main').classList.contains('success')) next();
        else check();
    };
    document.getElementById('b-speak').onclick = () => speak(state.cur.swedish_sentence.replace('__', state.ans || '...'));
    document.getElementById('b-hint').onclick = () => document.getElementById('feedback').innerText = state.cur.hint;
    document.getElementById('b-reveal').onclick = () => place(state.cur.missing_word);
}

init();
</script>
</body>
</html>